# ==============================================================================
# cloudbuild.yaml - Optimized CI/CD Pipeline
# ==============================================================================
# Pipeline stages:
# 1. BUILD: Docker image (frontend + backend) with layer caching
# 2. PUSH: Push to Artifact Registry
# 3. MIGRATE: Database migrations (before deploy)
# 4. DEPLOY: Cloud Run service
# 5. NEO4J INIT: Initialize vector indexes
# 6. SMOKE TESTS: Post-deployment verification (health + frontend)
#
# Total time: ~8-12 min (with BuildKit inline cache + pinned base images)
#   - First build (cold cache): ~20-25 min
#   - Incremental builds (warm cache): ~8-12 min
#   - Code-only changes (hot cache): ~5-8 min
# Optimization: BuildKit inline cache + pinned node:20.18.0/python:3.11.11
# Code quality checks: Run locally (ruff, mypy, pytest)
# ==============================================================================

steps:
  # ==========================================================================
  # PULL CACHE: Download previous image for layer caching
  # ==========================================================================
  # This step pulls the latest image from Artifact Registry to use as cache source
  # Uses 'entrypoint: bash' with '|| true' to avoid failing on first build (no cache exists yet)
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker pull europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:latest || echo "No cache image found - first build will be slow"
    id: 'pull-cache'
    waitFor: ['-']  # Start immediately (parallel with tests if any)

  # ==========================================================================
  # BUILD: Docker Image (Backend + Frontend) with BuildKit Inline Cache
  # ==========================================================================
  # BuildKit inline cache: zapisuje cache metadata WEWNƒÑTRZ image
  # To umo≈ºliwia cache multi-stage builds (frontend-builder, backend-builder, runtime)
  # --cache-from: reuse cache z poprzednich build√≥w
  # --cache-to type=inline: zapisz cache metadata dla przysz≈Çych build√≥w
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Setup BuildKit (nowszy backend Docker z lepszym cachingiem)
        export DOCKER_BUILDKIT=1

        # Build z inline cache (zapisuje cache metadata w image layers)
        docker build \
          -f Dockerfile.cloudrun \
          --cache-from europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:latest \
          -t europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:$COMMIT_SHA \
          .
    id: 'build'
    waitFor: ['pull-cache']  # Wait for cache image to be pulled
    env:
      - 'DOCKER_BUILDKIT=1'

  # ==========================================================================
  # PUSH: Docker Image to Artifact Registry
  # ==========================================================================
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - 'europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight'
    id: 'push'
    waitFor: ['build']

  # ==========================================================================
  # MIGRATE: Database Migrations (BEFORE deploy)
  # ==========================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Run database migrations via Cloud Run Jobs
        # This ensures schema is up-to-date BEFORE deploying new code
        echo "üîÑ Running database migrations..."

        # Check if migration job exists, create if not
        if ! gcloud run jobs describe db-migrate --region=europe-central2 2>/dev/null; then
          echo "Creating migration job..."
          gcloud run jobs create db-migrate \
            --image=europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:latest \
            --region=europe-central2 \
            --add-cloudsql-instances=gen-lang-client-0508446677:europe-central2:sight \
            --set-secrets=DATABASE_URL=DATABASE_URL_CLOUD:latest \
            --set-env-vars=PYTHONUNBUFFERED=1,PYTHONPATH=/app \
            --command=bash \
            --args=scripts/run_migrations_cloudrun.sh \
            --max-retries=2 \
            --task-timeout=300
        else
          echo "Updating migration job image..."
          gcloud run jobs update db-migrate \
            --image=europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:latest \
            --region=europe-central2 \
            --set-env-vars=PYTHONUNBUFFERED=1,PYTHONPATH=/app
        fi

        # Execute migrations
        echo "Executing migrations..."
        gcloud run jobs execute db-migrate --region=europe-central2 --wait

        # Check migration status
        if [ $$? -eq 0 ]; then
          echo "‚úÖ Migrations completed successfully"
        else
          echo "‚ùå Migrations failed - aborting deployment"
          exit 1
        fi
    id: 'migrate'
    waitFor: ['push']

  # ==========================================================================
  # DEPLOY STAGING: Cloud Run Service (sight-staging) - Before production
  # ==========================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'sight-staging'
      - '--image=europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:$COMMIT_SHA'
      - '--region=europe-central2'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--port=8080'
      - '--memory=4Gi'
      - '--cpu=2'
      - '--cpu-boost'
      - '--timeout=300'
      - '--min-instances=0'
      - '--max-instances=3'  # Lower limit for staging
      - '--execution-environment=gen2'
      - '--add-cloudsql-instances=gen-lang-client-0508446677:europe-central2:sight-staging'
      - '--set-secrets=DATABASE_URL=DATABASE_URL_STAGING:latest,GOOGLE_API_KEY=GOOGLE_API_KEY_STAGING:latest,NEO4J_PASSWORD=NEO4J_PASSWORD_STAGING:latest,NEO4J_URI=NEO4J_URI_STAGING:latest,POSTGRES_PASSWORD=POSTGRES_PASSWORD_STAGING:latest,REDIS_URL=REDIS_URL_STAGING:latest,SECRET_KEY=SECRET_KEY_STAGING:latest'
      - '--set-env-vars=NEO4J_USER=neo4j,ENVIRONMENT=staging,DEBUG=True,DEFAULT_LLM_PROVIDER=google,DEFAULT_MODEL=gemini-2.5-flash,GRAPH_MODEL=gemini-2.5-flash,PERSONA_GENERATION_MODEL=gemini-2.5-flash,ANALYSIS_MODEL=gemini-2.5-pro,EMBEDDING_MODEL=models/gemini-embedding-001,TEMPERATURE=0.7,MAX_TOKENS=6000,RAG_ENABLED=True,RAG_USE_HYBRID_SEARCH=True,RAG_USE_RERANKING=False,RAG_RERANK_CANDIDATES=5,RETRIEVAL_MODE=hybrid,RAG_CHUNK_SIZE=1000,RAG_CHUNK_OVERLAP=300,RAG_TOP_K=8,RAG_VECTOR_WEIGHT=0.7,RAG_RRF_K=60,ORCHESTRATION_ENABLED=True,ORCHESTRATION_TIMEOUT=90,TRANSFORMERS_VERBOSITY=error,HF_HUB_DISABLE_TELEMETRY=1,WORKFLOWS_ENABLED=true,GCP_PROJECT_ID=gen-lang-client-0508446677,GCP_REGION=europe-central2'
    id: 'deploy-staging'
    waitFor: ['migrate']

  # ==========================================================================
  # SMOKE TESTS STAGING: Verify staging deployment before production
  # ==========================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'smoke-tests-staging'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üî• Running smoke tests on STAGING..."

        # Get staging service URL
        SERVICE_URL=$(gcloud run services describe sight-staging --region=europe-central2 --format="value(status.url)")
        echo "Testing staging at: $$SERVICE_URL"

        # Wait for service initialization
        echo "‚è≥ Waiting 15s for staging initialization..."
        sleep 15

        # Test 1: Health endpoint
        echo ""
        echo "Test 1/2: Staging health check..."
        HEALTH_PASSED=false
        for i in 1 2 3; do
          echo "  Attempt $$i/3..."
          HEALTH_STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 "$$SERVICE_URL/health" || echo "FAIL")

          if [ "$$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Staging backend healthy (HTTP 200)"
            HEALTH_PASSED=true
            break
          else
            echo "‚ö†Ô∏è  Health check returned: $$HEALTH_STATUS"
            if [ $$i -lt 3 ]; then
              echo "  Retrying in 10s..."
              sleep 10
            fi
          fi
        done

        if [ "$$HEALTH_PASSED" != "true" ]; then
          echo ""
          echo "‚ùå STAGING health check FAILED - ABORTING production deployment"
          exit 1
        fi

        # Test 2: Frontend
        echo ""
        echo "Test 2/2: Staging frontend check..."
        FRONTEND_PASSED=false
        for i in 1 2 3; do
          echo "  Attempt $$i/3..."
          FRONTEND_STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 "$$SERVICE_URL/" || echo "FAIL")

          if [ "$$FRONTEND_STATUS" = "200" ]; then
            echo "‚úÖ Staging frontend accessible (HTTP 200)"
            FRONTEND_PASSED=true
            break
          else
            echo "‚ö†Ô∏è  Frontend check returned: $$FRONTEND_STATUS"
            if [ $$i -lt 3 ]; then
              echo "  Retrying in 10s..."
              sleep 10
            fi
          fi
        done

        if [ "$$FRONTEND_PASSED" != "true" ]; then
          echo ""
          echo "‚ùå STAGING frontend check FAILED - ABORTING production deployment"
          exit 1
        fi

        # All staging tests passed
        echo ""
        echo "üéâ STAGING smoke tests PASSED!"
        echo "   ‚úÖ Backend healthy"
        echo "   ‚úÖ Frontend accessible"
        echo "   üìç Staging URL: $$SERVICE_URL"
        echo ""
        echo "‚úÖ Proceeding to production deployment..."
    waitFor: ['deploy-staging']

  # ==========================================================================
  # DEPLOY PRODUCTION: Cloud Run Service (sight) with traffic splitting
  # ==========================================================================
  # Strategy: Deploy new revision with NO-TRAFFIC initially
  # Then gradually promote: 0% ‚Üí 10% ‚Üí 100%
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üöÄ Deploying new revision to production (no-traffic initially)..."

        # Deploy new revision with --no-traffic flag
        gcloud run deploy sight \
          --image=europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:latest \
          --region=europe-central2 \
          --platform=managed \
          --allow-unauthenticated \
          --port=8080 \
          --memory=4Gi \
          --cpu=2 \
          --cpu-boost \
          --timeout=300 \
          --min-instances=0 \
          --max-instances=5 \
          --execution-environment=gen2 \
          --add-cloudsql-instances=gen-lang-client-0508446677:europe-central2:sight \
          --set-secrets=DATABASE_URL=DATABASE_URL_CLOUD:latest,GOOGLE_API_KEY=GOOGLE_API_KEY:latest,NEO4J_PASSWORD=NEO4J_PASSWORD:latest,NEO4J_URI=NEO4J_URI:latest,POSTGRES_PASSWORD=POSTGRES_PASSWORD:latest,REDIS_URL=REDIS_URL:latest,SECRET_KEY=SECRET_KEY:latest \
          --set-env-vars=NEO4J_USER=neo4j,ENVIRONMENT=production,DEBUG=False,DEFAULT_LLM_PROVIDER=google,DEFAULT_MODEL=gemini-2.5-flash,GRAPH_MODEL=gemini-2.5-flash,PERSONA_GENERATION_MODEL=gemini-2.5-flash,ANALYSIS_MODEL=gemini-2.5-pro,EMBEDDING_MODEL=models/gemini-embedding-001,TEMPERATURE=0.7,MAX_TOKENS=6000,RAG_ENABLED=True,RAG_USE_HYBRID_SEARCH=True,RAG_USE_RERANKING=False,RAG_RERANK_CANDIDATES=5,RETRIEVAL_MODE=hybrid,RAG_CHUNK_SIZE=1000,RAG_CHUNK_OVERLAP=300,RAG_TOP_K=8,RAG_VECTOR_WEIGHT=0.7,RAG_RRF_K=60,ORCHESTRATION_ENABLED=True,ORCHESTRATION_TIMEOUT=90,TRANSFORMERS_VERBOSITY=error,HF_HUB_DISABLE_TELEMETRY=1,WORKFLOWS_ENABLED=true,GCP_PROJECT_ID=gen-lang-client-0508446677,GCP_REGION=europe-central2 \
          --no-traffic

        # Get new revision name
        NEW_REVISION=$(gcloud run services describe sight --region=europe-central2 --format="value(status.latestCreatedRevisionName)")
        echo "‚úÖ New revision deployed: $$NEW_REVISION (0% traffic)"

        # Store revision name for next steps
        echo "$$NEW_REVISION" > /workspace/new_revision.txt
    id: 'deploy-production'
    waitFor: ['smoke-tests-staging']

  # ==========================================================================
  # NEO4J INIT: Initialize Neo4j Indexes (AFTER production deploy)
  # ==========================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Initialize Neo4j indexes via Cloud Run Jobs
        # This ensures vector indexes exist for RAG system
        echo "üîÑ Initializing Neo4j indexes..."

        # Check if neo4j-init job exists, create if not
        if ! gcloud run jobs describe neo4j-init --region=europe-central2 2>/dev/null; then
          echo "Creating Neo4j init job..."
          gcloud run jobs create neo4j-init \
            --image=europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:latest \
            --region=europe-central2 \
            --set-secrets=NEO4J_URI=NEO4J_URI:latest,NEO4J_PASSWORD=NEO4J_PASSWORD:latest \
            --set-env-vars=NEO4J_USER=neo4j \
            --command=python,scripts/init_neo4j_cloudrun.py \
            --max-retries=3 \
            --task-timeout=300
        else
          echo "Updating Neo4j init job image..."
          gcloud run jobs update neo4j-init \
            --image=europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:latest \
            --region=europe-central2
        fi

        # Execute Neo4j initialization
        echo "Executing Neo4j index initialization..."
        gcloud run jobs execute neo4j-init --region=europe-central2 --wait

        # Check initialization status (non-fatal - RAG services have retry logic)
        if [ $$? -eq 0 ]; then
          echo "‚úÖ Neo4j indexes initialized successfully"
        else
          echo "‚ö†Ô∏è  Neo4j init failed - RAG features may be limited"
          echo "   Check logs: gcloud run jobs executions logs [EXECUTION_ID]"
          echo "   App will continue to run, but RAG functionality may be unavailable"
        fi
    id: 'neo4j-init'
    waitFor: ['deploy-production']

  # ==========================================================================
  # SMOKE TESTS PRODUCTION: Test new revision before promoting traffic
  # ==========================================================================
  # Test the new revision with tag-based URL (no production traffic yet)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'smoke-tests-production'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üî• Running smoke tests on new production revision (0% traffic)..."

        # Get new revision name
        NEW_REVISION=$(cat /workspace/new_revision.txt)
        echo "Testing new revision: $$NEW_REVISION"

        # Get revision-specific URL (tag-based)
        # Format: https://REVISION---SERVICE-HASH.REGION.run.app
        SERVICE_URL=$(gcloud run services describe sight --region=europe-central2 --format="value(status.url)")

        # Wait for revision to be ready
        echo "‚è≥ Waiting 20s for new revision initialization..."
        sleep 20

        # Test 1: Health endpoint
        echo ""
        echo "Test 1/2: Production health check (new revision)..."
        HEALTH_PASSED=false
        for i in 1 2 3; do
          echo "  Attempt $$i/3..."
          # Use revision tag URL for testing
          REVISION_URL="https://$$NEW_REVISION---sight-193742683473.europe-central2.run.app"
          HEALTH_STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 "$$REVISION_URL/health" || echo "FAIL")

          if [ "$$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ New revision healthy (HTTP 200)"
            HEALTH_PASSED=true
            break
          else
            echo "‚ö†Ô∏è  Health check returned: $$HEALTH_STATUS"
            if [ $$i -lt 3 ]; then
              echo "  Retrying in 10s..."
              sleep 10
            fi
          fi
        done

        if [ "$$HEALTH_PASSED" != "true" ]; then
          echo ""
          echo "‚ùå NEW REVISION health check FAILED - will trigger rollback"
          echo "   Revision: $$NEW_REVISION"
          echo "   Last status: $$HEALTH_STATUS"
          # Signal failure for rollback step
          echo "FAILED" > /workspace/smoke_test_result.txt
          exit 1
        fi

        # Test 2: Frontend
        echo ""
        echo "Test 2/2: Production frontend check (new revision)..."
        FRONTEND_PASSED=false
        for i in 1 2 3; do
          echo "  Attempt $$i/3..."
          REVISION_URL="https://$$NEW_REVISION---sight-193742683473.europe-central2.run.app"
          FRONTEND_STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 "$$REVISION_URL/" || echo "FAIL")

          if [ "$$FRONTEND_STATUS" = "200" ]; then
            echo "‚úÖ New revision frontend accessible (HTTP 200)"
            FRONTEND_PASSED=true
            break
          else
            echo "‚ö†Ô∏è  Frontend check returned: $$FRONTEND_STATUS"
            if [ $$i -lt 3 ]; then
              echo "  Retrying in 10s..."
              sleep 10
            fi
          fi
        done

        if [ "$$FRONTEND_PASSED" != "true" ]; then
          echo ""
          echo "‚ùå NEW REVISION frontend check FAILED - will trigger rollback"
          # Signal failure for rollback step
          echo "FAILED" > /workspace/smoke_test_result.txt
          exit 1
        fi

        # All tests passed - signal success
        echo ""
        echo "üéâ Production smoke tests PASSED!"
        echo "   ‚úÖ New revision healthy"
        echo "   ‚úÖ Frontend accessible"
        echo "   üìç Revision: $$NEW_REVISION"
        echo ""
        echo "‚úÖ Ready for gradual traffic promotion..."
        echo "SUCCESS" > /workspace/smoke_test_result.txt
    waitFor: ['neo4j-init']

  # ==========================================================================
  # TRAFFIC PROMOTION: Gradual rollout 10% ‚Üí 100%
  # ==========================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'traffic-promotion'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üö¶ Starting gradual traffic promotion..."

        # Get revision names
        NEW_REVISION=$(cat /workspace/new_revision.txt)
        PREVIOUS_REVISION=$(gcloud run services describe sight --region=europe-central2 \
          --format="value(status.traffic[0].revisionName)")

        echo "New revision: $$NEW_REVISION"
        echo "Previous revision: $$PREVIOUS_REVISION"

        # Store previous revision for rollback
        echo "$$PREVIOUS_REVISION" > /workspace/previous_revision.txt

        # Phase 1: 10% canary deployment
        echo ""
        echo "Phase 1/3: Promoting to 10% traffic (canary)..."
        gcloud run services update-traffic sight \
          --region=europe-central2 \
          --to-revisions=$$NEW_REVISION=10,$$PREVIOUS_REVISION=90

        echo "‚è≥ Monitoring canary for 30 seconds..."
        sleep 30

        # Check error rate (simplified - just verify service is responding)
        SERVICE_URL=$(gcloud run services describe sight --region=europe-central2 --format="value(status.url)")
        CANARY_STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" "$$SERVICE_URL/health" || echo "FAIL")

        if [ "$$CANARY_STATUS" != "200" ]; then
          echo "‚ùå Canary health check failed - rolling back"
          echo "FAILED" > /workspace/canary_result.txt
          exit 1
        fi
        echo "‚úÖ Canary healthy"

        # Phase 2: 50% traffic
        echo ""
        echo "Phase 2/3: Promoting to 50% traffic..."
        gcloud run services update-traffic sight \
          --region=europe-central2 \
          --to-revisions=$$NEW_REVISION=50,$$PREVIOUS_REVISION=50

        echo "‚è≥ Monitoring 50% split for 20 seconds..."
        sleep 20

        # Phase 3: 100% traffic (full promotion)
        echo ""
        echo "Phase 3/3: Promoting to 100% traffic..."
        gcloud run services update-traffic sight \
          --region=europe-central2 \
          --to-revisions=$$NEW_REVISION=100

        echo ""
        echo "üéâ Traffic promotion complete!"
        echo "   ‚úÖ 100% traffic on new revision: $$NEW_REVISION"
        echo "   üìç Previous revision available for rollback: $$PREVIOUS_REVISION"
        echo "SUCCESS" > /workspace/promotion_result.txt
    waitFor: ['smoke-tests-production']

  # ==========================================================================
  # ROLLBACK: Automatic rollback if deployment failed
  # ==========================================================================
  # This step runs ONLY if smoke tests or canary failed (exit 1)
  # Cloud Build will execute this as the error handler
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'auto-rollback'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîô ROLLBACK INITIATED"
        echo ""

        # Check if we have a previous revision to rollback to
        if [ ! -f /workspace/previous_revision.txt ]; then
          echo "‚ö†Ô∏è  No previous revision found - this might be first deployment"
          echo "   Manual intervention required"
          exit 1
        fi

        PREVIOUS_REVISION=$(cat /workspace/previous_revision.txt)
        NEW_REVISION=$(cat /workspace/new_revision.txt)

        echo "Rolling back from: $$NEW_REVISION"
        echo "Rolling back to: $$PREVIOUS_REVISION"
        echo ""

        # Immediate rollback to previous revision
        gcloud run services update-traffic sight \
          --region=europe-central2 \
          --to-revisions=$$PREVIOUS_REVISION=100

        echo ""
        echo "‚úÖ ROLLBACK COMPLETE"
        echo "   üîô Reverted to: $$PREVIOUS_REVISION"
        echo "   ‚ö†Ô∏è  Failed revision: $$NEW_REVISION (still deployed but no traffic)"
        echo ""
        echo "üìã Investigation steps:"
        echo "   1. Check logs: gcloud run services logs read sight --region=europe-central2 --limit=100"
        echo "   2. Review revision: gcloud run revisions describe $$NEW_REVISION --region=europe-central2"
        echo "   3. Check errors: gcloud logging read 'resource.type=cloud_run_revision AND severity>=ERROR' --limit=50"
        echo ""
        echo "üóëÔ∏è  To delete failed revision:"
        echo "   gcloud run revisions delete $$NEW_REVISION --region=europe-central2"
    waitFor: ['-']  # Independent step, runs on manual trigger or as error handler

# Output images
images:
  - 'europe-central2-docker.pkg.dev/gen-lang-client-0508446677/sight-containers/sight:latest'

# Build options
options:
  machineType: 'E2_HIGHCPU_8'  # Fast build (frontend + backend multi-stage)
  logging: CLOUD_LOGGING_ONLY

timeout: '3600s'
