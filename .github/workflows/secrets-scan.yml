# ==============================================================================
# secrets-scan.yml - Secrets Scanning CI/CD Pipeline
# ==============================================================================
# Purpose: Detect secrets, API keys, credentials in code and git history
# Tools: TruffleHog (primary), GitGuardian (secondary)
# Trigger: Every push, PR, and daily scheduled scan
#
# Security Goals:
# - Prevent accidental commit of secrets to repository
# - Scan entire git history for leaked credentials
# - Alert on findings immediately
# - Block deployment if secrets detected
# ==============================================================================

name: Secrets Scanning

on:
  # Run on every push to any branch
  push:
    branches:
      - '**'

  # Run on every pull request
  pull_request:
    branches:
      - '**'

  # Scheduled daily scan at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  trufflehog-scan:
    name: TruffleHog Secrets Scan
    runs-on: ubuntu-latest

    steps:
      # ==========================================================================
      # CHECKOUT: Full git history for deep scan
      # ==========================================================================
      - name: Checkout code (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches

      # ==========================================================================
      # TRUFFLEHOG: Scan entire git history
      # ==========================================================================
      - name: Run TruffleHog scan
        uses: trufflesecurity/trufflehog@main
        with:
          # Scan entire git history
          path: ./

          # Use base branch for PR scans, full history for push/schedule
          base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref || '' }}
          head: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || 'HEAD' }}

          # Use custom config file
          # NOTE: --fail flag is added automatically by trufflesecurity/trufflehog action
          extra_args: --config=.trufflehog.yaml --only-verified

      # ==========================================================================
      # SUMMARY: Display results
      # ==========================================================================
      - name: Scan summary
        if: success()
        run: |
          echo "✅ TruffleHog scan completed - no verified secrets found!"
          echo ""
          echo "Scanned: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      # ==========================================================================
      # ALERT: Notify on failure
      # ==========================================================================
      - name: Alert on secrets detected
        if: failure()
        run: |
          echo "❌ SECURITY ALERT: Secrets detected in repository!"
          echo ""
          echo "⚠️  ACTION REQUIRED:"
          echo "1. Review TruffleHog findings above"
          echo "2. Remove secrets from code immediately"
          echo "3. Rotate compromised credentials"
          echo "4. Use Google Secret Manager for secrets"
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"

  gitguardian-scan:
    name: GitGuardian Secrets Scan
    runs-on: ubuntu-latest

    # Only run if GITGUARDIAN_API_KEY secret is configured
    if: ${{ vars.GITGUARDIAN_ENABLED == 'true' }}

    steps:
      # ==========================================================================
      # CHECKOUT: Full git history
      # ==========================================================================
      - name: Checkout code (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================================
      # GITGUARDIAN: Scan with GitGuardian
      # ==========================================================================
      - name: Run GitGuardian scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        with:
          args: secret scan path . --recursive --show-secrets

      # ==========================================================================
      # SUMMARY: Display results
      # ==========================================================================
      - name: Scan summary
        if: success()
        run: |
          echo "✅ GitGuardian scan completed - no secrets found!"

  # ==========================================================================
  # HISTORICAL SCAN: Deep scan of entire git history (manual only)
  # ==========================================================================
  historical-scan:
    name: Historical Git Scan (Full History)
    runs-on: ubuntu-latest

    # Only run on manual trigger or scheduled
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}

    steps:
      - name: Checkout code (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Critical: fetch ALL commits

      - name: Run deep historical scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --config=.trufflehog.yaml --only-verified --fail --no-update

      - name: Historical scan summary
        if: success()
        run: |
          echo "✅ Historical scan completed!"
          echo ""
          echo "Scanned entire git history for secrets"
          echo "Repository: ${{ github.repository }}"
          echo "Total commits scanned: $(git rev-list --all --count)"

      - name: Alert on historical secrets
        if: failure()
        run: |
          echo "❌ CRITICAL: Secrets found in git history!"
          echo ""
          echo "⚠️  IMMEDIATE ACTION REQUIRED:"
          echo "1. Review findings and identify compromised secrets"
          echo "2. Rotate ALL affected credentials immediately"
          echo "3. Consider using BFG Repo-Cleaner to remove from history"
          echo "4. Notify security team"
          echo ""
          echo "Commands to investigate:"
          echo "  git log --all --oneline | grep -i 'secret\|key\|password'"
          echo "  git log --all --oneline --follow -- .env"

  # ==========================================================================
  # PREVENT DEPLOYMENT: Block if secrets detected
  # ==========================================================================
  prevent-deployment:
    name: Block Deployment on Secrets
    runs-on: ubuntu-latest
    needs: [trufflehog-scan]

    # Only run for main/staging branches (deployment branches)
    if: ${{ contains(fromJSON('["main", "staging"]'), github.ref_name) }}

    steps:
      - name: Check scan results
        run: |
          echo "✅ Secrets scan passed - deployment allowed"
          echo ""
          echo "Branch: ${{ github.ref_name }}"
          echo "Deployment pipeline can proceed safely"
